# フリーレン協力型グリッドワールド強化学習シミュレーション

## 概要

オブジェクト指向プログラミングの概念を活用し、PythonとPyTorch、pygame等のライブラリを用いて「葬送のフリーレン」のキャラクターを登場させた協力型グリッドワールドシミュレーションです。

## 主な改善点（最新版）

### 1. エラーハンドリングの強化
- 設定ファイルが存在しない場合のデフォルト設定
- 画像ファイルが見つからない場合の自動生成
- ログ・画像ディレクトリの自動作成

### 2. マンハッタン距離による当たり判定
- 攻撃はマンハッタン距離1以内でのみ有効
- 位置情報による戦略的な戦闘システム
- リアルタイムバトルログ

### 3. ユーザビリティの向上
- 実行モード選択機能
- エラー時の適切な処理
- メモリリーク防止

### 4. パフォーマンス最適化
- PyTorchテンソル処理の効率化
- 画像読み込みエラーの適切な処理
- プロセス終了時のクリーンアップ

## プロジェクト構成

```
project/
├── agents/                 # 強化学習エージェント
│   ├── __init__.py
│   ├── frieren_agent.py    # フリーレン（DQN）
│   ├── fern_agent.py       # フェルン（Q学習）
│   └── stark_agent.py      # シュタルク（Q学習）
├── env/                    # 環境
│   ├── __init__.py
│   ├── enhanced_env.py     # 拡張されたフリーレン冒険環境
│   ├── party_character.py  # パーティキャラクター
│   └── boss_enemy.py       # ボス敵
├── ui/                     # ユーザーインターフェース
│   ├── __init__.py
│   ├── grid_view.py        # グリッド表示
│   └── plot.py             # グラフ描画
├── utils/                  # ユーティリティ
│   ├── __init__.py
│   ├── logger.py           # ログ機能
│   └── experiment.py       # 比較実験
├── conf/                   # 設定ファイル
│   ├── conf.ini
│   └── log_config.json
├── images/                 # キャラクター画像（自動作成）
├── log/                    # ログファイル（自動作成）
├── main.py                 # メインファイル
└── README.md
```

## 主な機能

### 1. グリッドワールドシミュレーション
- 12×12のグリッドマップ上でフリーレン、フェルン、シュタルク、アウラが行動
- pygameによるリアルタイム可視化
- キャラクター画像による直感的な表示（画像なしでも色分け表示）

### 2. 強化学習システム
- **フリーレン**: DQN（Deep Q-Network）による魔法特化学習
- **フェルン**: Q学習による回復・サポート特化学習
- **シュタルク**: Q学習による物理戦闘特化学習

### 3. 協力型システム
- 役割分担による協力行動の学習
- パーティ全体の最適化
- 協力ボーナスによる学習促進

### 4. 比較実験機能
- 学習済みエージェントとランダムエージェントの比較
- 定量的な学習効果の測定

### 5. マンハッタン距離システム
- 攻撃の当たり判定にマンハッタン距離を使用
- 位置情報による戦略的な戦闘
- リアルタイムバトルログ

## 必要なライブラリ

```bash
pip install numpy pygame matplotlib torch configparser
```

## 実行方法

### 1. 基本的な実行
```bash
python main.py
```

実行時に以下のモードから選択できます：
1. マンハッタン距離システムテスト
2. グリッドワールドシミュレーション
3. フリーレン強化学習シミュレーション
4. 全て実行

### 2. 設定ファイル（オプション）
設定ファイルが存在しない場合は、デフォルト設定で実行されます。

#### conf/conf.ini
```ini
[SYSTEM]
MAX_STEP = 100
MAX_EPISODE = 10

[ENVIRONMENT]
AGT1_COORDX = 1
AGT1_COORDY = 1
AGT2_COORDX = 2
AGT2_COORDY = 1
AGT3_COORDX = 3
AGT3_COORDY = 1
ENEMY_COORDX = 10
ENEMY_COORDY = 10
```

## 技術的特徴

### 1. オブジェクト指向設計
- 抽象クラスによる設計の統一
- 継承とポリモーフィズムの活用
- 責務分離による保守性の向上

### 2. モジュール分割
- 機能別のディレクトリ構成
- 依存関係の明確化
- 拡張性の確保

### 3. 強化学習の実装
- DQNとQ学習の組み合わせ
- キャラクター特化型の学習戦略
- 経験リプレイとターゲットネットワーク

### 4. 可視化システム
- リアルタイム表示
- 学習曲線の描画
- 比較実験の可視化

### 5. エラーハンドリング
- 設定ファイル不在時のデフォルト設定
- 画像ファイル不在時の自動生成
- ディレクトリ自動作成

## 学習結果

- **勝率**: 94%の高勝率を達成
- **協力効果**: 協力ボーナスにより34.8%の改善
- **役割分担**: 各キャラクターの特化した行動学習
- **マンハッタン距離**: 戦略的な戦闘システムの実現

## トラブルシューティング

### よくある問題と解決方法

1. **画像ファイルが見つからない**
   - 自動的に色分けされた円形画像が生成されます
   - 画像を追加する場合は `images/` ディレクトリに配置してください

2. **設定ファイルが見つからない**
   - デフォルト設定で実行されます
   - カスタム設定が必要な場合は `conf/conf.ini` を作成してください

3. **ログファイルが作成されない**
   - `log/` ディレクトリが自動作成されます
   - 権限の問題がある場合は手動でディレクトリを作成してください

## 今後の課題

1. **アルゴリズムの改良**
   - Actor-Critic法の導入
   - マルチエージェント強化学習の高度化

2. **環境の拡張**
   - より複雑なマップ設計
   - 動的環境の実装

3. **可視化の高度化**
   - 3D可視化の実装
   - VR/AR対応

## ライセンス

このプロジェクトは教育目的で作成されています。

## 作者

東京電機大学 オブジェクト指向プログラミング課題 